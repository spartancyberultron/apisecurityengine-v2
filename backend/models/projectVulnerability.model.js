const mongoose = require('mongoose');
const Ticket = require('./ticket.model'); // Adjust the path as needed

const projectVulnerabilitySchema = new mongoose.Schema({
  project: { 
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Project',
  },
  vulnerability: { 
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Vulnerability',
  },  
  endpoint: { 
    type: String, 
  },  
  description: {
    type: String, 
  },
  riskAcceptance: {
    type: String, 
  },
  riskAcceptanceReason: {
    type: String, 
  },
  findings: {
    type: [String], 
  },
  sslFindings: {
    type: [Object], 
  },
  additionalCWEs: {
    type: [String], 
  },
  remediation:{
    type: String, 
  },  
  severity:{
    type: String, 
  },
  priority:{
    type: String, 
  },
}, {
  timestamps: true,
});

// Middleware to create a ticket after saving a ProjectVulnerability record
projectVulnerabilitySchema.post('save', async function(doc) {
  
  try {
    // Populate the vulnerability reference
    await doc.populate({
      path: 'vulnerability',
      populate: {
        path: 'orgProject',
        populate: {
          path: 'organization',
          populate: {
            path: 'primaryUser'
          }
        }
      }
    }).execPopulate();

    // Populate the project reference
    await doc.populate({
      path: 'project',
      populate: {
        path: 'orgProject',
        populate: {
          path: 'organization',
          populate: {
            path: 'primaryUser'
          }
        }
      }
    }).execPopulate();

    // Extract populated fields
    const { project, vulnerability } = doc;

    // Create the ticket
    const ticket = new Ticket({
      title: vulnerability.vulnerabilityName, // Assuming vulnerability has a vulnerabilityName field
      description: `${doc.description} ${doc.findings.join(', ')}`,
      source: 'API Traffic Scan',
      category: 'Security Vulnerability',
      organization: project.orgProject.organization._id, // Assuming project.orgProject.organization is populated
      scanId: project._id, // Use project._id as the scanId
      status: 'OPEN',
      priority: doc.severity,
      openedBy: project.orgProject.organization.primaryUser // Assuming primaryUser is populated
    });

    // Save the ticket
    await ticket.save();
  } catch (err) {
    console.error('Error creating ticket:', err);
  }
});

const ProjectVulnerability = mongoose.model('ProjectVulnerability', projectVulnerabilitySchema);

module.exports = ProjectVulnerability;
